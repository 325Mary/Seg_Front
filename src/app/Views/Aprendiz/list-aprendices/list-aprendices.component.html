<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="col-12 d-flex flex-row flex-wrap">
          <div class="col-md-3 col-12">
            <input type="text" class="form-control" placeholder="Buscar por Identificacion Aprendiz"
              [(ngModel)]="filterIdentificacion" />
          </div>
          <div class="d-flex col-md-7 col-12 justify-content-start flex-wrap col-mt-4">
            
            <div *ngIf="nombreDoc != null" class="col-12 mb-2">
              <span>Documento Seleccionado</span>
              <h6>{{ nombreDoc }}</h6>
            </div>
            
            <div class="col-xl-4 col-lg-5 d-flex justify-content-end col-12">
              <button class="btn btn-success upload w-100" mat-raised-button (click)="fileInput.click()">
                Cargar Excel
              </button>
              <input hidden #fileInput type="file" (change)="onDocumentChange($event)" accept=".xlsx" />
            </div>
            
            <!-- Botón Subir - solo visible cuando docValido es true y NO está en preview -->
            <div class="col-2 d-flex justify-content-end">
              <button 
                *ngIf="docValido == true && !showPreview" 
                (click)="sendFile()" 
                class="btn btn-success upload w-100"
                [disabled]="!canSendFile()"
                [class.btn-secondary]="!canSendFile()"
                [title]="(isPerfil4 && !selectedCentro) ? 'Seleccione un centro de formación' : 'Subir archivo'">
                Subir
              </button>
            </div>
          </div>
        </div>

        <!-- Alerta informativa para perfil 4 -->
        <div *ngIf="isPerfil4 && docValido && !selectedCentro && !showPreview" class="alert alert-warning mt-3" role="alert">
          <i class="fa-solid fa-exclamation-triangle"></i>
          <strong>Atención:</strong> Debes seleccionar un centro de formación antes de importar el archivo Excel.
        </div>

        <!-- Modal de Vista Previa -->
        <div *ngIf="showPreview" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999; display: flex; align-items: center; justify-content: center;" (click)="closePreview()">
          <div style="background: white; width: 95%; height: 90%; border-radius: 10px; display: flex; flex-direction: column;" (click)="$event.stopPropagation()">
            
            <!-- Header -->
            <div style="background: #39A900; color: white; padding: 20px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
              <h4 style="margin: 0;">Vista Previa - {{ nombreDoc }}</h4>
              <button (click)="closePreview()" style="background: none; border: none; color: white; font-size: 30px; cursor: pointer;">×</button>
            </div>

            <!-- Info y Selector -->
            <div style="padding: 15px; background: #f8f9fa; border-bottom: 2px solid #ddd;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                  <strong>✓ Validación exitosa</strong> - 
                  Registros: <strong>{{ excelData.length }}</strong> | 
                  Columnas: <strong>{{ excelHeaders.length }}</strong>
                </div>
                
                <!-- Selector de Centro - Solo para perfil 4 -->
                <div *ngIf="isPerfil4" style="min-width: 300px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 13px;">
                    <i class="fa-solid fa-building"></i> Centro de Formación *
                  </label>
                  <select class="form-control" [(ngModel)]="selectedCentro">
                    <option value="">Seleccione un centro</option>
                    <option *ngFor="let centro of listCentros" [value]="centro.id_centro_formacion">
                      {{ centro.nombre }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Tabla de datos -->
            <div style="flex: 1; overflow: auto; padding: 20px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead style="position: sticky; top: 0; background: #343a40; color: white;">
                  <tr>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; position: sticky; left: 0; background: #23272b; z-index: 10;">#</th>
                    <th *ngFor="let header of excelHeaders" style="padding: 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; min-width: 150px;">{{ header }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of excelData; let i = index" style="background: white;">
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; position: sticky; left: 0; background: #f8f9fa; font-weight: bold; z-index: 5;">{{ i + 1 }}</td>
                    <td *ngFor="let header of excelHeaders" style="padding: 10px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">{{ row[header] || '-' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Footer con botones -->
            <div style="padding: 20px; background: #f8f9fa; border-top: 2px solid #ddd; display: flex; justify-content: flex-end; gap: 10px;">
              <button (click)="closePreview()" class="btn btn-secondary">Cerrar</button>
              <button 
                (click)="confirmImport()" 
                class="btn btn-success"
                [disabled]="isPerfil4 && !selectedCentro"
                [class.btn-secondary]="isPerfil4 && !selectedCentro"
                [title]="(isPerfil4 && !selectedCentro) ? 'Seleccione un centro de formación' : 'Confirmar e importar'">
                Confirmar e Importar
              </button>
            </div>

          </div>
        </div>

        <!-- Tabla de Aprendices -->
        <div class="card">
          <div class="card-header card-header-sena-azul">
            <h4 class="card-title">Aprendices</h4>
            <div class="row ml-1">
              <p class="card-category">
                En este apartado podrás ver todos los Aprendices
              </p>
              <div class="d-flex col justify-content-end">
                <button routerLink="/register-aprendiz" class="btn btn-success ml-5">
                  NUEVO
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table *ngIf="listAprendices !== null" class="table">
                <thead class="text-verde-sena">
                  <th class="text-center">Centro Formación</th>
                  <th class="text-center">Empresa</th>
                  <th class="text-center">Identificación</th>
                  <th class="text-center">Nombre</th>
                  <th class="text-center">Correo</th>
                  <th class="text-center">Ficha</th>
                  <th class="text-center">Programa</th>
                  <th class="text-center">Asignado</th>
                  <th class="text-center">Acciones</th>
                </thead>

                <tbody>
                  <tr *ngFor="
                      let aprendiz of listAprendices
                        | filterAssignments : filterIdentificacion
                        | paginate
                          : { itemsPerPage: 7, currentPage: pageActual }
                    ">
                    <td class="text-center">{{ aprendiz.nombre_centro }}</td>
                    <td class="text-center">{{ aprendiz.nombre_empresa }}</td>
                    <td class="text-center">{{ aprendiz.identificacion }}</td>
                    <td class="text-center">{{ aprendiz.nombres }} {{ aprendiz.apellidos }}</td>
                    <td class="text-center">{{ aprendiz.correo_alternativo }}</td>
                    <td class="text-center">{{ aprendiz.ficha }}</td>
                    <td class="text-center">{{ aprendiz.programa_formacion }}</td>
                    <td class="text-center">
                        <div *ngIf="aprendiz.id_asignacion != null; else sinAsignar">
                          <P class="text-success"><b>SI</b></P>
                        </div>
                        <ng-template #sinAsignar>
                          <P class="text-danger"><b>NO</b></P>
                        </ng-template>
                      </td>  
                    <td class="text-center">
                      <div class="comtainer">
                        <i tooltip="Ver datos aprendiz {{ aprendiz.nombres }} {{ aprendiz.apellidos }} " 
                          placement="bottom" showDelay="200" class="butonW" 
                          [routerLink]="['/ver-detalle-aprendiz/', aprendiz.id_aprendiz]">
                          <span class="fa-solid fa-eye "></span>
                        </i>
                        <i tooltip="Asignar aprendiz {{ aprendiz.nombres }} {{ aprendiz.apellidos }} a un Instructor "
                          placement="bottom" showDelay="200" class="butonW" 
                          [routerLink]="['/assignment-aprendiz/', aprendiz.id_aprendiz]">
                          <span class="fa-solid fa-list-check"></span>
                        </i>
                        <i tooltip="Eliminar aprendiz {{ aprendiz.nombres }} {{ aprendiz.apellidos }} "
                          *ngIf="aprendiz.id_asignacion == null" placement="bottom" showDelay="200" class="butonW"
                          (click)="deleteREPwithAprendiz(aprendiz.id_aprendiz)">
                          <span class="fa-solid fa-trash text-danger"></span>
                        </i>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <h5 *ngIf="listAprendices == null">
                No hay aprendices registrados
              </h5>
              <pagination-controls (pageChange)="pageActual = $event" previousLabel="Anterior  "
                nextLabel="Siguiente"></pagination-controls>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>